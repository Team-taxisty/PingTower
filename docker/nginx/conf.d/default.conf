server {
    listen 80;
    server_name _;  # Используйте '_' для захвата всех хостов или укажите ваш домен/IP для внешнего доступа

    # Логи для отладки
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Увеличьте количество worker-процессов и соединений для лучшей обработки并发ных запросов
    # Добавьте это в nginx.conf (вне блока server), если не указано
    # worker_processes auto;
    # events { worker_connections 1024; }

    # Frontend - Прокси на статические файлы React
    location / {
        proxy_pass http://pingtower-frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Увеличенные таймауты для обработки нескольких пользователей
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Backend API - Прокси на Spring Boot (/v1/)
    location /v1/ {
        proxy_pass http://pingtower-backend:8080/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Объединённая обработка CORS
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Увеличенные таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Маршрут совместимости API (/api/ -> /v1/api/)
    location /api/ {
        proxy_pass http://pingtower-backend:8080/v1/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Те же CORS-заголовки
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Увеличенные таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Bot API - Раскомментируйте и настройте при необходимости
    # location /bot/ {
    #     proxy_pass http://pingtower-bot:5000/;
    #     # Добавьте похожие proxy_set_header, CORS и таймауты, как выше
    # }

    # Эндпоинт проверки здоровья
    location /health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }
}
