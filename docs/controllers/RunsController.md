# RunsController

REST API контроллер для получения данных о запусках проверок (runs) в системе мониторинга PingTower.

## Обзор

`RunsController` предоставляет API эндпоинты для:
- Получения истории запусков проверок
- Фильтрации по конкретным проверкам и временным диапазонам
- Анализа производительности и статуса проверок

## Базовый URL

```
/runs
```

## Эндпоинты

### GET /runs
Получить список запусков проверок с возможностью фильтрации.

**Параметры запроса:**
- `check_id` (UUID, optional) - ID конкретной проверки для фильтрации
- `from` (DateTime, optional) - начальная дата фильтрации в формате ISO 8601
- `to` (DateTime, optional) - конечная дата фильтрации в формате ISO 8601
- `limit` (Integer, optional) - максимальное количество записей (по умолчанию 1000, максимум 10000)

**Пример запроса:**
```http
GET /runs?check_id=550e8400-e29b-41d4-a716-446655440000&from=2024-01-15T00:00:00Z&to=2024-01-15T23:59:59Z&limit=100
```

**Ответ:**
```json
{
  "items": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "check_id": "550e8400-e29b-41d4-a716-446655440000",
      "started_at": "2024-01-15T10:30:00Z",
      "finished_at": "2024-01-15T10:30:01Z",
      "latency_ms": 1200,
      "status": "UP"
    },
    {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "check_id": "550e8400-e29b-41d4-a716-446655440000",
      "started_at": "2024-01-15T10:25:00Z",
      "finished_at": "2024-01-15T10:25:02Z",
      "latency_ms": 2000,
      "status": "DOWN"
    }
  ]
}
```

## Структура данных Run

### RunDto
```json
{
  "id": "UUID",
  "check_id": "UUID",
  "started_at": "DateTime (ISO 8601)",
  "finished_at": "DateTime (ISO 8601)",
  "latency_ms": "Integer",
  "status": "String"
}
```

### Поля

- **id** (UUID) - уникальный идентификатор запуска
- **check_id** (UUID) - идентификатор проверки, к которой относится запуск
- **started_at** (DateTime) - время начала выполнения проверки
- **finished_at** (DateTime) - время завершения выполнения проверки
- **latency_ms** (Integer) - время выполнения в миллисекундах
- **status** (String) - статус проверки

## Статусы проверок

- **UP** - сервис доступен и работает нормально
- **DOWN** - сервис недоступен
- **DEGRADED** - сервис работает с проблемами (медленно или с ошибками)

## Фильтрация

### По времени
Используйте параметры `from` и `to` для фильтрации по временному диапазону:

```http
# Получить запуски за последние 24 часа
GET /runs?from=2024-01-14T12:00:00Z&to=2024-01-15T12:00:00Z

# Получить запуски за конкретный день
GET /runs?from=2024-01-15T00:00:00Z&to=2024-01-15T23:59:59Z
```

### По проверке
Используйте параметр `check_id` для получения запусков конкретной проверки:

```http
GET /runs?check_id=550e8400-e29b-41d4-a716-446655440000
```

### Комбинированная фильтрация
Можно комбинировать все параметры:

```http
GET /runs?check_id=550e8400-e29b-41d4-a716-446655440000&from=2024-01-15T00:00:00Z&limit=50
```

## Сортировка

Результаты всегда сортируются по времени `started_at` в убывающем порядке (новые записи первыми).

## Ограничения

- **limit**: от 1 до 10000 (по умолчанию 1000)
- **Временные диапазоны**: рекомендуется не более 30 дней для оптимальной производительности
- **Пагинация**: не поддерживается, используйте параметр `limit`

## Примеры использования

### Получение последних 100 запусков
```bash
curl -X GET "http://localhost:8080/runs?limit=100" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Получение запусков конкретной проверки за последние 24 часа
```bash
curl -X GET "http://localhost:8080/runs?check_id=550e8400-e29b-41d4-a716-446655440000&from=2024-01-14T12:00:00Z" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Получение всех запусков за день
```bash
curl -X GET "http://localhost:8080/runs?from=2024-01-15T00:00:00Z&to=2024-01-15T23:59:59Z" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Коды ответов HTTP

- `200 OK` - Успешный запрос
- `400 Bad Request` - Некорректные параметры запроса
- `401 Unauthorized` - Отсутствует или недействительный JWT токен
- `500 Internal Server Error` - Внутренняя ошибка сервера

## Обработка ошибок

### Некорректный UUID
```json
{
  "error": "Invalid UUID format",
  "message": "check_id parameter must be a valid UUID"
}
```

### Превышение лимита
```json
{
  "error": "Limit exceeded",
  "message": "limit parameter must be between 1 and 10000"
}
```

## Интеграция с фронтендом

Данный контроллер активно используется в следующих компонентах фронтенда:

### CheckDetail.js
- Отображение истории проверок для конкретного сервиса
- Построение графиков производительности
- Расчет метрик (uptime, среднее время ответа)

### Reports.js
- Генерация отчетов по производительности
- Анализ трендов и статистики

## Производительность

### Рекомендации по использованию
- Используйте фильтрацию по `check_id` для получения данных конкретной проверки
- Ограничивайте временные диапазоны (не более 30 дней)
- Используйте разумные значения `limit` (100-1000 для большинства случаев)

### Оптимизация запросов
- Результаты кэшируются на короткое время
- Индексы по времени и check_id для быстрого поиска
- Автоматическая очистка старых данных

## Текущие ограничения

⚠️ **Важно**: В текущей реализации используется `InMemoryRunService`, что означает:

- Данные хранятся только в памяти приложения
- При перезапуске приложения все данные теряются
- Нет интеграции с реальной системой мониторинга
- Данные не сохраняются в базе данных

### Планируемые улучшения
- Интеграция с `CheckResultRepository` для получения реальных данных
- Сохранение данных в базе данных
- Автоматическое заполнение данных из результатов проверок
- Поддержка пагинации для больших объемов данных

## Зависимости

Контроллер использует следующие компоненты:
- `RunService` - интерфейс для работы с данными запусков
- `InMemoryRunService` - текущая реализация (в памяти)
- `RunDto` - модель данных для передачи информации о запусках

## Безопасность

Все эндпоинты требуют JWT аутентификации. Токен должен быть передан в заголовке `Authorization: Bearer <token>`.

## Мониторинг

- Все запросы логируются
- Медленные запросы (>500ms) помечаются в логах
- Метрики использования доступны через `/actuator/metrics`
