# Пакет Monitoring

Пакет мониторинга предоставляет расширенные возможности мониторинга веб‑сервисов для системы PingTower. Он реализует гибридную архитектуру с использованием PostgreSQL для структурированных данных и последних результатов, а также ClickHouse для аналитики временных рядов и хранения исторических данных.

## Архитектура

Пакет мониторинга состоит из нескольких ключевых компонентов:

### Конфигурация (`config/`)
- **ClickHouseConfig**: конфигурация подключения к базе временных рядов ClickHouse
- **MonitoringProperties**: свойства приложения для настройки системы мониторинга
- **MessagingConfig**: константы конфигурации для обмена сообщениями RabbitMQ (будет расширено)

### Слой репозиториев (`repository/`)
- **ClickHouseRepository**: интерфейс для операций с данными временных рядов
- **ClickHouseRepositoryImpl**: высокопроизводительная реализация аналитики на ClickHouse
- **MonitoredServiceRepository**: JPA‑репозиторий PostgreSQL для управления конфигурацией сервисов
- **CheckResultRepository**: JPA‑репозиторий PostgreSQL для последних результатов проверок

### Слой сервисов (`service/`)
- **MonitoringService**: базовый сервис, координирующий поток данных между PostgreSQL и ClickHouse
- **MonitoringAnalyticsService**: сервис для агрегации метрик и формирования отчетов
- **MonitoredServiceManager**: CRUD‑операции для конфигурации мониторируемых сервисов
- **DataSynchronizationService**: миграция и синхронизация данных между базами

### Обмен сообщениями (`messaging/`)
- **MonitoringEventPublisher**: интерфейс публикации событий мониторинга
- **MonitoringEventConsumer**: интерфейс потребления событий мониторинга
- **SimpleMonitoringEventPublisher**: базовая реализация (будет заменена на RabbitMQ)

## Ключевые возможности

### Аналитика временных рядов
- Высокопроизводительное хранилище в ClickHouse, оптимизированное под данные мониторинга
- Автоматическое партиционирование таблиц по месяцам с политиками TTL
- Эффективные запросы для расчета аптайма, метрик времени ответа и анализа трендов

### Мониторинг в реальном времени
- Обработка результатов проверок от планировщика
- Определение статуса сервиса (UP, DOWN, DEGRADED, UNKNOWN)
- Агрегация данных для дашборда с метриками в реальном времени

### Отчетность по SLA
- Автоматический расчет соответствия SLA
- Отслеживание и отчетность по простоям
- Анализ трендов производительности

### Управление данными
- Автоматическая очистка старых данных мониторинга
- Пакетная обработка для высоких объемов загрузки
- Настраиваемые политики хранения

## Архитектура баз данных

### PostgreSQL (структурированные данные и последние результаты)
- **MonitoredService**: конфигурации сервисов, привязка пользователей, настройки мониторинга
- **CheckResult**: последние результаты проверок (за последние 30 дней) для быстрого доступа дашборда
- **AlertRule**: конфигурация оповещений и пороги
- **User**: управление пользователями и правами

### ClickHouse (аналитика временных рядов)
- **check_results_ts**: исторические данные мониторинга с автоматическим партиционированием
- **service_metrics_ts**: предагрегированные метрики для различных периодов
- Оптимизировано для аналитических запросов и больших объемов данных
- Политики TTL для автоматической очистки данных

### Поток данных
1. **Результаты проверок**: сразу сохраняются в PostgreSQL, затем реплицируются в ClickHouse
2. **Исторические данные**: мигрируются из PostgreSQL в ClickHouse через 7 дней
3. **Аналитика**: выполняется в ClickHouse для оптимальной производительности
4. **Актуальные данные**: извлекаются из PostgreSQL для быстрых обновлений дашборда

## Конфигурация

Добавьте следующие свойства в ваш `application.yaml`:

```yaml
monitoring:
  clickhouse:
    url: jdbc:clickhouse://localhost:8123/monitoring
    username: default
    password: ""
    driver-class-name: com.clickhouse.jdbc.ClickHouseDriver
  analytics:
    batch-size: 1000
    flush-interval-seconds: 60
    enable-real-time-metrics: true
    aggregation-periods: "1h,6h,1d,7d,30d"
```

## Использование

### Обработка результатов проверок
```java
@Autowired
private MonitoringService monitoringService;

// Обработка одного результата проверки
monitoringService.processCheckResult(checkResult);

// Пакетная обработка нескольких результатов
monitoringService.processCheckResults(checkResults);
```

### Получение данных дашборда
```java
// Получение данных дашборда мониторинга для сервиса
LocalDateTime start = LocalDateTime.now().minusHours(24);
LocalDateTime end = LocalDateTime.now();
MonitoringDashboardData dashboardData = 
    monitoringService.getDashboardData(serviceId, start, end);
```

### Формирование отчетов SLA
```java
@Autowired
private MonitoringAnalyticsService analyticsService;

// Генерация отчета SLA за последний месяц
LocalDateTime start = LocalDateTime.now().minusDays(30);
LocalDateTime end = LocalDateTime.now();
SLAReport report = analyticsService.generateSLAReport(serviceId, start, end);
```

## Точки интеграции

### С пакетом Scheduler
Пакет мониторинга получает результаты проверок от пакета планировщика через:
- Прямые вызовы методов
- События очереди сообщений (после внедрения RabbitMQ)

### С пакетом Storage
Пакет мониторинга использует модели из пакета хранения:
- `CheckResult`: данные отдельного результата проверки
- `ServiceMetrics`: агрегированные метрики сервиса
- `MonitoredService`: конфигурация сервиса (только чтение)

### С пакетом API
Пакет мониторинга может быть опубликован через REST‑эндпоинты для:
- Получения данных дашборда
- Генерации отчетов SLA
- Запросов статуса сервиса

## Дальнейшее развитие

1. **Интеграция RabbitMQ**: заменить простую реализацию обмена сообщениями на полноценный RabbitMQ
2. **Обработка оповещений**: интеграция с правилами оповещений и системой уведомлений
3. **Потоковая обработка в реальном времени**: поддержка real‑time стриминга данных
4. **Продвинутая аналитика**: обнаружение аномалий на основе машинного обучения
5. **Мульти‑региональная поддержка**: кросс‑региональный мониторинг и агрегация

## Особенности производительности

- ClickHouse оптимизирован для аналитических запросов по временным рядам
- Пакетная обработка снижает накладные расходы на отдельные вставки
- Автоматическое партиционирование улучшает производительность запросов
- Политики TTL автоматически управляют ростом объема данных
- Индексы по столбцам `service_id` и `timestamp` оптимизируют частые запросы

## Зависимости

Необходимые зависимости в `build.gradle`:
- `com.clickhouse:clickhouse-jdbc:0.6.5` — драйвер ClickHouse JDBC
- `org.springframework.boot:spring-boot-starter-amqp` — поддержка RabbitMQ (для будущего использования)
- Стандартные стартеры Spring Boot для JPA, web и validation
